<!doctype html PUBLIC>
<html>

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>打卡</title>
		<meta name="viewport" content="width=device-width user-scalable= 'no'">
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
		<link rel="stylesheet" type="text/css" href="plugins/weui/css/weui.css" />
		<link rel="stylesheet" type="text/css" href="plugins/weui/css/weuix.css" />
		<link rel="stylesheet" type="text/css" href="css/iconfont.css" />
		<link rel="stylesheet" type="text/css" href="plugins/mui/css/mui.min.css" />
		<link rel="stylesheet" href="css/reset.css" />
		<link rel="stylesheet" type="text/css" href="css/base.css" />
		<link rel="stylesheet" type="text/css" href="css/swiper.min.css" />
		<link rel="stylesheet" type="text/css" href="css/simple-calendar.css">
		<link rel="stylesheet" type="text/css" href="css/clockIn.css" />
	</head>

	<body>
		<div class="weui-tab">
			<div class="weui-tab__bd">
				<!--打卡-->
				<div id="tab1" class="weui-tab__bd-item  weui-tab__bd-item--active">
					<div id='container'></div>
					<div class="daka-info" style="display: none;">
						<h4 id='status'></h4>
						<hr>
						<p id='result'></p>
						<hr>
					</div>

					<div id="box" class="">
						<div class="daka-btn" id='show-toast'>
							<button id='signbtn' class="text layui-btn layui-btn-normal">上班打卡</button>
							<div id='time'>广达创远</div>
						</div>
						<div class="hint">
							请在8:30前打卡
						</div>
						<div id="place" type="button" class="layui-btn-radius">非办公地点</div>
						<div id='distance'>系统正在定位中</div>
						<div id='location'>系统正在定位中</div>
					</div>
				</div>
				<!--记录-->
				<div id="tab2" class="weui-tab__bd-item statistics">
					<div id="clockIn-record">
						<div class="bd" id="container">
							<div id="content" class="weui-cells">
								<!--头部-->
								<div class="weui-cell report-cell">
									<div class="customer-group">
										<div class="img">刘</div>
										<div class="time-info">
											<div class="info-myAtt">
												<div class="name-info">
													<div class="">
														<span class="name">刘垣辰</span>
													</div>
													<div class="date">软件研发部</div>
												</div>
											</div>
										</div>
										<div class="detail">
											<div class="state">
												<a class="monthly" href="clockIn-monthRecord.html">月报</a>
											</div>
										</div>
									</div>
								</div>
								<!--日历-->
								<div class="inner">
									<div id='calendar' class="sc-calendar">
										<div class="sc-header">
											<div class="sc-title">
												<div class="year"><span class="sc-select-year" name=""></span>年</div>
												<div class="month">
													<div class="arrow sc-mleft"></div>
													<div class="monthdiv">
														<span class="sc-select-month" name=""></span>
													</div>
													<div class="arrow sc-mright"></div>
												</div>
											</div>
											<div class="sc-week"></div>
										</div>
										<div class="sc-body">
											<div class="sc-days"></div>
										</div>
									</div>
									<!--<div class="announcement">
										<ul class="matter">
										</ul>
										<ul class="zcmatter">
										</ul>
									</div>-->
								</div>
							</div>
							<!--上下班打卡状态-->
							<div id="content" class="weui-cells weui-form workRecord">
								<div class="weui-cell">
									<div class="weui-cell__hd">
										<div class="des">上下班打卡</div>
										<div class="workTime">工作时长:<span>8小时</span></div>
									</div>
								</div>

								<div class="weui-cell report-cell">
									<div class="record-info onDuty">
										<div class="timeBox">
											09:30
										</div>
										<div class="record-state success">
											<p class="des">上班</p>
											<p class="text">上班打卡<span class="time">(09:28)</span></p>
										</div>
										<div class="record-state failed">
											<p class="des ">上班</p>
											<p class="text">未打卡</p>
										</div>
									</div>
									<div class="record-info">
										<div class="timeBox">
											09:30
										</div>
										<div class="record-state normal">
											<p class="des">下班</p>
											<p class="text" style="display: none;">下班打卡<span class="time">(09:28)</span></p>
										</div>
									</div>

								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!--底部固定导航-->
			<div class="weui-tabbar">
				<a href="#tab1" class="weui-tabbar__item weui-bar__item--on">
					<div class="weui-tabbar__icon">
						<i class="iconfont icon-qiandao"></i>
					</div>
					<p class="weui-tabbar__label active">打卡</p>
				</a>
				<a href="#tab2" class="weui-tabbar__item  ">
					<div class="weui-tabbar__icon">
						<i class="iconfont icon-tongji"></i>
					</div>
					<p class="weui-tabbar__label">我的记录</p>
				</a>
				<!--<a href="#tab3" class="weui-tabbar__item  ">
					<div class="weui-tabbar__icon">
						<i class="iconfont icon-tongji"></i>
					</div>
					<p class="weui-tabbar__label">设置</p>
				</a>-->
			</div>
		</div>

		<script src="plugins/weui/js/jquery-2.1.4.js"></script>
		<script src="plugins/weui/js/fastclick.js"></script>
		<script src="plugins/weui/js/swiper.min.js"></script>

		<script src="plugins/weui/js/jquery-weui.min.js"></script>
		<script src="plugins/weui/js/jquery-weui.js"></script>
		<script type="text/javascript" src="js/baes.js"></script>
		<!--地图-->
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.15&key=b4da6160d26765a356e21ace59ccbc3a"></script>
		<script src="https://webapi.amap.com/maps?v=1.4.15&key=b4da6160d26765a356e21ace59ccbc3a&plugin=AMap.CircleEditor"></script>
		<script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
		<!--日历-->
		<script type="text/javascript" src="js/simple-calendar.js"></script>
		<script type="text/javascript" src="js/hammer-2.0.8-min.js"></script>
		<script src="js/clockIn.js"></script>
		<script type="text/javascript">
			//点击穿透
			$(function() {
				FastClick.attach(document.getElementById('show-toast'));
			});
		</script>
<script type="text/javascript">
	/*-------------地图-------------*/
var map = new AMap.Map('container', {
	resizeEnable: true,
});
AMap.plugin('AMap.Geolocation', function() {
	var geolocation = new AMap.Geolocation({
		enableHighAccuracy: true, //是否使用高精度定位，默认:true
		timeout: 10000, //超过10秒后停止定位，默认：5s
		buttonPosition: 'RB', //定位按钮的停靠位置
		buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
		zoomToAccuracy: true, //定位成功后是否自动调整地图视野到定位点
	});
	map.addControl(geolocation);
	geolocation.getCurrentPosition(function(status, result) {
		if(status == 'complete') {
			onComplete(result);
			alert("定位成功")
		} else {
			onError(result);
			alert("定位失败")
			$(".reload").click();
			alert("刷新页面")
		}
	});
});
//解析定位结果
function onComplete(data) {
	document.getElementById('status').innerHTML = '定位成功'
	var str = [];
	str.push('定位结果：' + data.position);
	str.push('定位类别：' + data.location_type);
	if(data.accuracy) {
		str.push('精度：' + data.accuracy + ' 米');
	} //如为IP精确定位结果则没有精度信息
	str.push('是否经过偏移：' + (data.isConverted ? '是' : '否'));
	document.getElementById('result').innerHTML = str.join('<br>');

	getposition = [data.position.lng, data.position.lat]; //获取当前位置的经纬度
	var location = data.formattedAddress; //具体街道位置信息
	console.log(getposition);

	var shanghaizone = [113.68060648, 34.79333863]; //设置的签到点
	//计算当前位置与考勤点距离
	var distance = AMap.GeometryUtil.distance(getposition, shanghaizone).toFixed(0);

	console.log(distance);
	//document.getElementById('distance').innerHTML = distancestr;
	var setDistance = 150; //设定的打卡距离

	document.getElementById('location').innerHTML = location;

	var distancestr = '仍距' + distance + '米';
	console.log(distance);

	if(distance <= setDistance) {
		//在范围内
		document.getElementById('distance').innerHTML = '</i><i class="layui-icon layui-icon-face-smile" style="font-size:12px; color:#17bc84; border-radius: 10px;">  你已进入考勤范围  </i>  ';
		document.getElementById("place").innerHTML = "办公地点 ";
		$("#place").addClass("isdiy");
		//$("#signbtn").html("外勤打卡")

	} else {
		//不在范围内
		document.getElementById('distance').innerHTML = '<div style="display:inline" class="layui-icon layui-icon-face-cry" style="font-size: 10px; color:red;  border-radius: 10px;">  当前不在考勤范围 </div><a class="reload" style="color:#29a6ff" onClick="window.location.reload()">重新定位 </a> ';
		document.getElementById("place").innerHTML = "非办公地点 ";
		$("#place").addClass("nodiy");
		$("#signbtn").html("外勤打卡")
	}

	$("#signbtn").click(function() {

		if(distance <= setDistance) {
			layer.msg("办公地点打卡");
		} else {
			layer.msg("外勤打卡");
		}
	});

	//绘制签到范围
	var circle = new AMap.Circle({
		center: shanghaizone,
		radius: 1000, //半径
		borderWeight: 1,
		strokeOpacity: 1,
		strokeOpacity: 0.2,
		fillOpacity: 0.4,
	})

	circle.setMap(map)
	// 缩放地图到合适的视野级别
	map.setFitView([circle])
	var circleEditor = new AMap.CircleEditor(map, circle);

	/*--------------签到-----------------*/
	$(document).on("click", "#show-toast", function() {
		trimAdress = $("#location").text();
		$("#show-toast").addClass("active")
			.find(".text").html("打卡成功")
		$("#show-toast").removeAttr("id");
		startTime()
		//打印地址和时间
		$.toast("打卡成功", function() {
			alert(trimAdress);
			alert(getposition);
			alert($("#time").text());

		});
	})
}
//解析定位错误信息
function onError(data) {
	document.getElementById('location').innerHTML = '定位失败';
	document.getElementById('location').innerHTML = '失败原因排查信息:' + data.message;
	console.log("定位失败")
}
//初始化地图
//function createMap() {
//	map = new AMap.Map('container', {
//		resizeEnable: true
//	});
//	log.success("创建地图成功");
//}


/*--------------时钟---------------- */
function startTime() {
	var today = new Date()
	var h = today.getHours()
	var m = today.getMinutes()
	var s = today.getSeconds()
	// add a zero in front of numbers<10
	m = checkTime(m)
	s = checkTime(s)
	document.getElementById('time').innerHTML = h + ":" + m + ":" + s
	t = setTimeout('startTime()', 500)
}

function checkTime(i) {
	if(i < 10) {
		i = "0" + i
	}
	return i
}

		</script>
	</body>

</html>
